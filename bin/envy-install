#!/usr/bin/env ruby

require 'open3'

$LOAD_PATH.unshift File.expand_path("../lib", __dir__) # For use/testing when no gem is installed
require "envy"

sys = Envy::HostSystem

if sys.platform.type == :Windows
  STDERR.puts 'Not implemented yet'
  exit 1
end

module InstallerCommon
  VERSION_TEXT = "installer for envy v#{Envy::VERSION}"

  def run(argv)
    opts = {}
    argv.select! do |arg|
      !case arg
        when '-h', '--help', 'help' then opts[:help] = true
        when '-v', '--version'      then opts[:ver] = true
        else false
      end
    end

    if opts[:ver]
      puts VERSION_TEXT
      return 0
    end

    if opts[:help]
      puts VERSION_TEXT
      puts usage_text
      puts help_text
      return 0
    end

    return do_run(argv)
  end
end

class Installer
  include InstallerCommon
  def initialize(sys)
    @sys = sys
  end
  def detect_installed_envy?()
    stdout, stderr, code = Open3.capture3("bash -ic 'command -v envy'")
    code.success?
  end
  def usage_text
    <<~EOF
      envy-install [--help] [--version] [--dotfile <path>]
    EOF
  end
  def help_text
    <<~EOF
      HELP HELP
    EOF
  end
  SOURCE = 'envy.sh'
  ENVY_INSTALLATION_BEGIN = '#### BEGIN envy installation (don\'t remove line)'
  ENVY_INSTALLATION_END = '#### END envy installation (don\'t remove line)'
  def try_install(dotfile)
    install_lines = [
      ENVY_INSTALLATION_BEGIN,
      File.read(File.join(__dir__, SOURCE)),
      ENVY_INSTALLATION_END
    ]

    if File.exist?(dotfile)
      if !File.file?(dotfile)
        STDERR.puts "'#{dotfile}' exists but is not a file. You need to choose a file."
        return 1
      end

      # file exists
      # first try to identify if an envy installation is present
      lines = File.readlines(dotfile)
      first = lines.length
      num = 0
      lines.each_with_index do |l, i|
        lc = l.chomp
        if lc == ENVY_INSTALLATION_BEGIN
          first = i
        elsif lc == ENVY_INSTALLATION_END
          num = i - first + 1
        end
      end

      lines[first, num] = install_lines
      install_lines = lines
    end

    File.open(dotfile, 'w') do |file|
      file.puts install_lines
    end
    return 0
  end
  DEFAULT_DOTFILE = 'brc-test'
  def do_run(argv)
    return try_install(File.join(Dir.home, DEFAULT_DOTFILE)) if argv.empty?

    if argv.shift != '--dotfile' || argv.length != 1
      puts usage_text
      return 1
    end

    dotfile = argv[0]
    dotfile = File.join(Dir.pwd, dotfile) if !@sys.platform.likely_abs_path?(dotfile)
    return try_install(dotfile)
  end
end

installer = Installer.new(sys)

if installer.detect_installed_envy?
  puts "It seems that you already have envy installed"
  puts "Do you want to reinstall it? (y,n)"
end

exit installer.run(ARGV.dup)
